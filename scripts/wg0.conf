#!/bin/sh
### BEGIN INIT INFO
# Provides:          wg-router
# Required-Start:    $network
# Required-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: WireGuard IPv6 router + ip6tables hardening + auto routes
### END INIT INFO

PATH=/sbin:/usr/sbin:/bin:/usr/bin
WG_IF="wg0"
LAN_IF="wlan0"
WAN_IF="tun0"              # ProtonVPN / kimenet interface - állítsd be ha más
WG_CONF="/etc/wireguard/${WG_IF}.conf"
WG_QUICK="$(command -v wg-quick 2>/dev/null || true)"
WG_BIN="$(command -v wg 2>/dev/null || true)"
IP6TABLES="$(command -v ip6tables 2>/dev/null || true)"
IP="$(command -v ip 2>/dev/null || true)"
SYSCTL="$(command -v sysctl 2>/dev/null || true)"

# ellenőrzés
[ -n "$IP6TABLES" ] || { echo "HIBA: ip6tables nem található."; exit 1; }
[ -n "$IP" ] || { echo "HIBA: ip nem található."; exit 1; }

# === Helper functions ===

do_sysctl_forward() {
  [ -n "$SYSCTL" ] && {
    $SYSCTL -w net.ipv6.conf.all.forwarding=1 >/dev/null 2>&1 || true
    $SYSCTL -w net.ipv6.conf.default.forwarding=1 >/dev/null 2>&1 || true
    # alap hardening runtime:
    $SYSCTL -w net.ipv6.conf.all.accept_redirects=0 >/dev/null 2>&1 || true
    $SYSCTL -w net.ipv6.conf.all.accept_source_route=0 >/dev/null 2>&1 || true
  }
}

# idempotens ip6tables add
ip6_add() {
  $IP6TABLES -C "$@" >/dev/null 2>&1 || $IP6TABLES -A "$@"
}

# idempotens ip6tables delete (lenyel ha nincs)
ip6_del() {
  $IP6TABLES -D "$@" >/dev/null 2>&1 || true
}

# Alap ip6tables hardening (NDP / ICMP szabályok, multicast célzott drop)
add_hardening_rules() {
  echo "wg-router: Alap ip6tables hardening alkalmazása..."
  # alap policies feltételezve más script kezeli INPUT/OUTPUT általánost;
  # itt csak a fontos ICMPv6/NDP és multicast protection jön
  # NDP/ICMP alapok (133-136 RA/RS/NS/NA) - rate-limittel
  ip6_add INPUT -p ipv6-icmp --icmpv6-type router-solicitation -m limit --limit 30/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type router-advertisement -m limit --limit 30/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type neighbor-solicitation -m limit --limit 200/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type neighbor-advertisement -m limit --limit 200/min -j ACCEPT

  # Path MTU / hibák
  ip6_add INPUT -p ipv6-icmp --icmpv6-type packet-too-big -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type destination-unreachable -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type time-exceeded -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type parameter-problem -j ACCEPT

  # ping rate-limit
  ip6_add INPUT -p ipv6-icmp --icmpv6-type echo-request -m limit --limit 30/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type echo-reply -m limit --limit 60/min -j ACCEPT

  # Célzott multicast tiltás: mDNS IPv6 (ff02::fb) ergonómikus tiltás
  ip6_add INPUT -d ff02::fb -j DROP

  # Ha extra solicited-node prefixeket találsz gyanúsnak, ide teheted: pl.
  # ip6_add INPUT -d ff02:0:0:0:0:1:ff00:0/104 -j DROP

  # Log limitáltan végén (nem túl hangos)
  ip6_add INPUT -m limit --limit 5/min -j LOG --log-prefix "IP6-DROP: " --log-level 4
}

remove_hardening_rules() {
  echo "wg-router: Hardening szabályok eltávolítása..."
  ip6_del INPUT -p ipv6-icmp --icmpv6-type router-solicitation -m limit --limit 30/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type router-advertisement -m limit --limit 30/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type neighbor-solicitation -m limit --limit 200/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type neighbor-advertisement -m limit --limit 200/min -j ACCEPT

  ip6_del INPUT -p ipv6-icmp --icmpv6-type packet-too-big -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type destination-unreachable -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type time-exceeded -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type parameter-problem -j ACCEPT

  ip6_del INPUT -p ipv6-icmp --icmpv6-type echo-request -m limit --limit 30/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type echo-reply -m limit --limit 60/min -j ACCEPT

  ip6_del INPUT -d ff02::fb -j DROP
  ip6_del INPUT -m limit --limit 5/min -j LOG --log-prefix "IP6-DROP: " --log-level 4
}

# WG up/down (wg-quick preferált, fallback wg + ip)
wg_up() {
  if [ -n "$WG_QUICK" ] && [ -f "$WG_CONF" ]; then
    echo "wg-router: wg-quick up $WG_IF"
    $WG_QUICK up "$WG_IF" >/dev/null 2>&1 || {
      echo "wg-quick up visszadobott, próbálkozunk fallback módon..."
      wg_setconf_fallback
    }
  elif [ -n "$WG_BIN" ] && [ -f "$WG_CONF" ]; then
    echo "wg-router: wg setconf fallback"
    wg_setconf_fallback
  else
    echo "wg-router: nincs wg-quick vagy wg, vagy nem található $WG_CONF" >&2
    return 1
  fi
  return 0
}

wg_setconf_fallback() {
  # egyszerűebb fallback: bring up link, setconf
  if [ -n "$IP" ]; then
    $IP link set dev "$WG_IF" up >/dev/null 2>&1 || true
  fi
  if [ -n "$WG_BIN" ] && [ -f "$WG_CONF" ]; then
    $WG_BIN setconf "$WG_IF" "$WG_CONF" >/dev/null 2>&1 || true
  fi
}

wg_down() {
  if [ -n "$WG_QUICK" ]; then
    echo "wg-router: wg-quick down $WG_IF"
    $WG_QUICK down "$WG_IF" >/dev/null 2>&1 || true
  elif [ -n "$WG_BIN" ]; then
    # próbáljuk szelíden leállítani
    echo "wg-router: wg fallback down"
    $WG_BIN set "$WG_IF" listen-port 0 >/dev/null 2>&1 || true
    $IP link set dev "$WG_IF" down >/dev/null 2>&1 || true
  fi
}

# Peer AllowedIPs parsing a wg configból (biztonságos, nem próbálunk fragilis 'wg show dump' parsinget)
# Csak IPv6 AllowedIPs-eket veszünk figyelembe; route-okat hozunk létre az up-nál és törlünk a down-nál.
parse_wgconf_and_manage_routes() {
  action="$1"  # add | del
  [ -f "$WG_CONF" ] || return 0

  # Olvassuk a configot és keressük az AllowedIPs sorokat a [Peer] blokkokból
  # Támogatjuk a több AllowedIPs, vesszõvel elválasztott és több soros formátumot
  # Csak IPv6 címeket nézünk meg (':' a könnyű szűrés)
  awk '
    BEGIN { peer=0 }
    /^\[Peer\]/ { peer=1; next }
    /^\[/ && $0 !~ /^\[Peer\]/ { peer=0 }
    peer && /^AllowedIPs[ \t]*=/ {
      sub(/^[^=]*=[ \t]*/, "", $0)
      print $0
    }
  ' "$WG_CONF" | tr -d ' \t' | tr ',' '\n' | while read -r aip; do
    [ -z "$aip" ] && continue
    # Csak IPv6 sorokat kezeljük
    case "$aip" in
      *:*) ;;  # IPv6 tartalmaz ':'
      *) continue ;;
    esac
    # lehet tartalmazni /64 vagy /128 - csak route-ot kezelünk
    if [ "$action" = "add" ]; then
      echo "wg-router: route add $aip dev $WG_IF"
      $IP -6 route replace "$aip" dev "$WG_IF" proto static metric 518 >/dev/null 2>&1 || true
    else
      echo "wg-router: route del $aip dev $WG_IF"
      $IP -6 route del "$aip" dev "$WG_IF" >/dev/null 2>&1 || true
    fi
  done
}

# FORWARD szabályek (LAN <-> WAN, LAN -> WG stb.) idempotens módon
add_forward_rules() {
  echo "wg-router: FORWARD szabályok hozzáadása..."
  ip6_add FORWARD -i "$LAN_IF" -o "$WAN_IF" -j ACCEPT
  ip6_add FORWARD -i "$LAN_IF" -o "$WG_IF" -j ACCEPT
  ip6_add FORWARD -i "$WG_IF" -o "$WAN_IF" -j ACCEPT
  ip6_add FORWARD -i "$WAN_IF" -o "$LAN_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  ip6_add FORWARD -i "$WAN_IF" -o "$WG_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  # és általános established vissza
  ip6_add FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
}

remove_forward_rules() {
  echo "wg-router: FORWARD szabályok eltávolítása..."
  ip6_del FORWARD -i "$LAN_IF" -o "$WAN_IF" -j ACCEPT
  ip6_del FORWARD -i "$LAN_IF" -o "$WG_IF" -j ACCEPT
  ip6_del FORWARD -i "$WG_IF" -o "$WAN_IF" -j ACCEPT
  ip6_del FORWARD -i "$WAN_IF" -o "$LAN_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  ip6_del FORWARD -i "$WAN_IF" -o "$WG_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  ip6_del FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
}

# status helper
show_status() {
  echo "=== wg-router status ==="
  if $IP link show dev "$WG_IF" >/dev/null 2>&1; then
    $IP -6 addr show dev "$WG_IF"
    [ -n "$WG_BIN" ] && $WG_BIN show "$WG_IF" 2>/dev/null || true
  else
    echo "$WG_IF nem található (down?)"
  fi
  echo ""
  echo "ip6tables FORWARD:"
  $IP6TABLES -L FORWARD -v --line-numbers
  echo "======================="
}

# ===== main =====
case "$1" in
  start)
    echo "wg-router: start"
    do_sysctl_forward
    add_hardening_rules
    wg_up || { echo "wg up sikertelen."; }
    add_forward_rules
    parse_wgconf_and_manage_routes add
    echo "wg-router: start vége."
    ;;
  stop)
    echo "wg-router: stop"
    # elsőként távolítsuk el a route-okat, majd a forward szabályokat, végül a wg-t
    parse_wgconf_and_manage_routes del
    remove_forward_rules
    wg_down
    remove_hardening_rules
    echo "wg-router: stop vége."
    ;;
  restart|force-reload)
    echo "wg-router: restart"
    $0 stop
    sleep 1
    $0 start
    ;;
  status)
    show_status
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac

exit 0

