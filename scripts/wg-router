#!/bin/sh
### BEGIN INIT INFO
# Provides:          wg-router
# Required-Start:    $network
# Required-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: WireGuard IPv6 router + ip6tables hardening + auto routes + persist
### END INIT INFO

PATH=/sbin:/usr/sbin:/bin:/usr/bin
WG_IF="wg0"
LAN_IF="wlan0"
WAN_IF="tun0"              # ProtonVPN / kimenet interface - állítsd be ha más
WG_CONF="/etc/wireguard/${WG_IF}.conf"
WG_QUICK="$(command -v wg-quick 2>/dev/null || true)"
WG_BIN="$(command -v wg 2>/dev/null || true)"
IP6TABLES="$(command -v ip6tables 2>/dev/null || true)"
IP6TABLES_RESTORE="$(command -v ip6tables-restore 2>/dev/null || true)"
IP6TABLES_SAVE="$(command -v ip6tables-save 2>/dev/null || true)"
IP="$(command -v ip 2>/dev/null || true)"
SYSCTL="$(command -v sysctl 2>/dev/null || true)"

RULES_FILE="/etc/iptables/rules.v6"
SYSCTL_FILE="/etc/sysctl.d/99-ipv6-forward.conf"

# ellenőrzés
[ -n "$IP6TABLES" ] || { echo "HIBA: ip6tables nem található."; exit 1; }
[ -n "$IP" ] || { echo "HIBA: ip nem található."; exit 1; }

do_sysctl_forward() {
  [ -n "$SYSCTL" ] && {
    $SYSCTL -w net.ipv6.conf.all.forwarding=1 >/dev/null 2>&1 || true
    $SYSCTL -w net.ipv6.conf.default.forwarding=1 >/dev/null 2>&1 || true
    $SYSCTL -w net.ipv6.conf.all.accept_redirects=0 >/dev/null 2>&1 || true
    $SYSCTL -w net.ipv6.conf.all.accept_source_route=0 >/dev/null 2>&1 || true
  }
  # persistálás: csak ha nincs, akkor írjuk (ne írjunk felül személyre szabott fájlokat)
  if [ ! -f "$SYSCTL_FILE" ]; then
    cat > "$SYSCTL_FILE" <<'EOF'
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.all.accept_source_route = 0
EOF
    # ne futtassunk szisztematikus sysctl --system minden egyes startnál: de legyen gyorsan érvényesítve
    [ -n "$SYSCTL" ] && $SYSCTL --system >/dev/null 2>&1 || true
  fi
}

# idempotens ip6tables add
ip6_add() {
  $IP6TABLES -C "$@" >/dev/null 2>&1 || $IP6TABLES -A "$@"
}

# idempotens ip6tables delete (lenyel ha nincs)
ip6_del() {
  $IP6TABLES -D "$@" >/dev/null 2>&1 || true
}

save_rules() {
  if [ -n "$IP6TABLES_SAVE" ]; then
    echo "wg-router: ip6tables mentés -> $RULES_FILE"
    $IP6TABLES_SAVE > "$RULES_FILE" 2>/dev/null || echo "wg-router: mentés sikertelen"
  fi
}

restore_rules() {
  if [ -n "$IP6TABLES_RESTORE" ] && [ -f "$RULES_FILE" ]; then
    echo "wg-router: talált $RULES_FILE, visszatöltés..."
    $IP6TABLES_RESTORE < "$RULES_FILE" 2>/dev/null || echo "wg-router: restore sikertelen vagy hibás fájl, folytatjuk..."
  fi
}

# Alap ip6tables hardening (NDP / ICMP szabályok, multicast célzott drop)
add_hardening_rules() {
  echo "wg-router: Alap ip6tables hardening alkalmazása..."
  ip6_add INPUT -p ipv6-icmp --icmpv6-type router-solicitation -m limit --limit 30/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type router-advertisement -m limit --limit 30/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type neighbor-solicitation -m limit --limit 200/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type neighbor-advertisement -m limit --limit 200/min -j ACCEPT

  ip6_add INPUT -p ipv6-icmp --icmpv6-type packet-too-big -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type destination-unreachable -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type time-exceeded -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type parameter-problem -j ACCEPT

  ip6_add INPUT -p ipv6-icmp --icmpv6-type echo-request -m limit --limit 30/min -j ACCEPT
  ip6_add INPUT -p ipv6-icmp --icmpv6-type echo-reply -m limit --limit 60/min -j ACCEPT

  # célzott mDNS tiltás (biztos, ha nem szolgálsz mDNS-t)
  ip6_add INPUT -d ff02::fb -j DROP

  # védelem: log limitáltan (ha nincs logolás beállítva, ez nem csinál nagy kárt)
  ip6_add INPUT -m limit --limit 5/min -j LOG --log-prefix "IP6-DROP: " --log-level 4
}

remove_hardening_rules() {
  echo "wg-router: Hardening szabályok eltávolítása..."
  ip6_del INPUT -p ipv6-icmp --icmpv6-type router-solicitation -m limit --limit 30/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type router-advertisement -m limit --limit 30/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type neighbor-solicitation -m limit --limit 200/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type neighbor-advertisement -m limit --limit 200/min -j ACCEPT

  ip6_del INPUT -p ipv6-icmp --icmpv6-type packet-too-big -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type destination-unreachable -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type time-exceeded -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type parameter-problem -j ACCEPT

  ip6_del INPUT -p ipv6-icmp --icmpv6-type echo-request -m limit --limit 30/min -j ACCEPT
  ip6_del INPUT -p ipv6-icmp --icmpv6-type echo-reply -m limit --limit 60/min -j ACCEPT

  ip6_del INPUT -d ff02::fb -j DROP
  ip6_del INPUT -m limit --limit 5/min -j LOG --log-prefix "IP6-DROP: " --log-level 4
}

wg_setconf_fallback() {
  if [ -n "$IP" ]; then
    $IP link set dev "$WG_IF" up >/dev/null 2>&1 || true
  fi
  if [ -n "$WG_BIN" ] && [ -f "$WG_CONF" ]; then
    $WG_BIN setconf "$WG_IF" "$WG_CONF" >/dev/null 2>&1 || true
  fi
}

wg_up() {
  if [ -n "$WG_QUICK" ] && [ -f "$WG_CONF" ]; then
    echo "wg-router: wg-quick up $WG_IF"
    $WG_QUICK up "$WG_IF" >/dev/null 2>&1 || { echo "wg-quick up visszadobott, fallback..."; wg_setconf_fallback; }
  elif [ -n "$WG_BIN" ] && [ -f "$WG_CONF" ]; then
    echo "wg-router: wg setconf fallback"
    wg_setconf_fallback
  else
    echo "wg-router: nincs wg-quick vagy wg, vagy nem található $WG_CONF" >&2
    return 1
  fi
  return 0
}

wg_down() {
  if [ -n "$WG_QUICK" ]; then
    echo "wg-router: wg-quick down $WG_IF"
    $WG_QUICK down "$WG_IF" >/dev/null 2>&1 || true
  elif [ -n "$WG_BIN" ]; then
    echo "wg-router: wg fallback down"
    $WG_BIN set "$WG_IF" listen-port 0 >/dev/null 2>&1 || true
    $IP link set dev "$WG_IF" down >/dev/null 2>&1 || true
  fi
}

parse_wgconf_and_manage_routes() {
  action="$1"  # add | del
  [ -f "$WG_CONF" ] || return 0

  awk '
    BEGIN { peer=0 }
    /^\[Peer\]/ { peer=1; next }
    /^\[/ && $0 !~ /^\[Peer\]/ { peer=0 }
    peer && /^AllowedIPs[ \t]*=/ {
      sub(/^[^=]*=[ \t]*/, "", $0)
      print $0
    }
  ' "$WG_CONF" | tr -d ' \t' | tr ',' '\n' | while read -r aip; do
    [ -z "$aip" ] && continue
    case "$aip" in
      *:*) ;;  # IPv6 candidate
      *) continue ;;
    esac
    if [ "$action" = "add" ]; then
      echo "wg-router: route add $aip dev $WG_IF"
      $IP -6 route replace "$aip" dev "$WG_IF" proto static metric 518 >/dev/null 2>&1 || true
    else
      echo "wg-router: route del $aip dev $WG_IF"
      $IP -6 route del "$aip" dev "$WG_IF" >/dev/null 2>&1 || true
    fi
  done
}

add_forward_rules() {
  echo "wg-router: FORWARD szabályok hozzáadása..."
  ip6_add FORWARD -i "$LAN_IF" -o "$WAN_IF" -j ACCEPT
  ip6_add FORWARD -i "$LAN_IF" -o "$WG_IF" -j ACCEPT
  ip6_add FORWARD -i "$WG_IF" -o "$WAN_IF" -j ACCEPT
  ip6_add FORWARD -i "$WAN_IF" -o "$LAN_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  ip6_add FORWARD -i "$WAN_IF" -o "$WG_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  ip6_add FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
}

remove_forward_rules() {
  echo "wg-router: FORWARD szabályok eltávolítása..."
  ip6_del FORWARD -i "$LAN_IF" -o "$WAN_IF" -j ACCEPT
  ip6_del FORWARD -i "$LAN_IF" -o "$WG_IF" -j ACCEPT
  ip6_del FORWARD -i "$WG_IF" -o "$WAN_IF" -j ACCEPT
  ip6_del FORWARD -i "$WAN_IF" -o "$LAN_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  ip6_del FORWARD -i "$WAN_IF" -o "$WG_IF" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  ip6_del FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
}

show_status() {
  echo "=== wg-router status ==="
  if $IP link show dev "$WG_IF" >/dev/null 2>&1; then
    $IP -6 addr show dev "$WG_IF"
    [ -n "$WG_BIN" ] && $WG_BIN show "$WG_IF" 2>/dev/null || true
  else
    echo "$WG_IF nem található (down?)"
  fi
  echo ""
  echo "ip6tables FORWARD:"
  $IP6TABLES -L FORWARD -v --line-numbers
  echo "======================="
}

case "$1" in
  start)
    echo "wg-router: start"
    do_sysctl_forward
    restore_rules
    add_hardening_rules
    wg_up || { echo "wg up sikertelen."; }
    add_forward_rules
    parse_wgconf_and_manage_routes add
    save_rules
    echo "wg-router: start vége."
    ;;
  stop)
    echo "wg-router: stop"
    parse_wgconf_and_manage_routes del
    remove_forward_rules
    wg_down
    remove_hardening_rules
    # nem töröljük a mentést; ha akarod, manuálisan törölheted a $RULES_FILE-t
    echo "wg-router: stop vége."
    ;;
  restart|force-reload)
    echo "wg-router: restart"
    $0 stop
    sleep 1
    $0 start
    ;;
  status)
    show_status
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac

exit 0

