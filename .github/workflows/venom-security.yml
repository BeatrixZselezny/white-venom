name: üêç White-Venom Security & Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  cpp-sast:
    name: C++ Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck
      - name: Run Cppcheck
        run: cppcheck debian_skeleton/src -I debian_skeleton/include --enable=all --inconclusive --suppress=missingIncludeSystem --inline-suppr --verbose || true

  shell-audit:
    name: ShellCheck (Bash scripts)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        run: shopt -s nullglob && shellcheck debian_skeleton/*.sh scripts/*.sh || echo "Warnings found"

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  build:
    name: Build Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install BPF Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libbpf-dev libelf-dev clang llvm pkg-config build-essential linux-headers-$(uname -r)

      - name: Fix BPF Header Paths (The "Shut Up" fix)
        run: |
          # Ha a k√≥d <bpf/bpf.h>-t keres, de a rendszerben csak /usr/include/bpf.h van, 
          # vagy ford√≠tva, ez a tr√ºkk megoldja:
          sudo ln -sf /usr/include/bpf /usr/include/bpf/bpf || true
          # Biztos ami biztos, tegy√ºk el√©rhet≈ëv√© a sima include k√∂nyvt√°rban is
          sudo cp -r /usr/include/bpf/* /usr/include/ 2>/dev/null || true

      - name: Configure CMake
        run: |
          # K√©nyszer√≠tett √∫tvonalak minden lehets√©ges m√≥don
          export CPLUS_INCLUDE_PATH="/usr/include:/usr/include/bpf:$CPLUS_INCLUDE_PATH"
          export C_INCLUDE_PATH="/usr/include:/usr/include/bpf:$C_INCLUDE_PATH"
          cmake -S . -B build -DCMAKE_CXX_FLAGS="-I/usr/include -I/usr/include/bpf"

      - name: Build
        run: cmake --build build --verbose
